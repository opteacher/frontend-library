<template>
  <a-button
    v-if="!getProp(form, prop) || !getProp(form, `${prop}.xpath`)"
    class="w-full"
    :type="selecting ? 'primary' : 'default'"
    @click="onSelEleStart"
  >
    选择元素
  </a-button>
  <a-input-group v-else compact class="flex">
    <a-tooltip>
      <template #title>{{ label }}</template>
      <a-dropdown class="flex-1 truncate" :trigger="['click']">
        <template #overlay>
          <a-menu @click="onElIdChange">
            <a-menu-item key="xpath">xpath</a-menu-item>
            <a-menu-item key="idCls">ID或类</a-menu-item>
            <a-menu-item key="tagName">标签</a-menu-item>
          </a-menu>
        </template>
        <a-button type="primary" ghost>
          {{ label }}
          <DownOutlined />
        </a-button>
      </a-dropdown>
    </a-tooltip>
    <a-popconfirm title="确定解绑该元素吗？" @confirm="onSelEleClear">
      <a-button type="primary" ghost danger>
        <template #icon><CloseOutlined /></template>
      </a-button>
    </a-popconfirm>
  </a-input-group>
</template>

<script setup lang="ts" name="EleSelField">
import { getProp, setProp } from '../utils'
import { CloseOutlined, DownOutlined } from '@ant-design/icons-vue'
import { computed, ref, toRef } from 'vue'
import PageEle, { type IdType } from '../types/pageEle'
import { TinyEmitter } from 'tiny-emitter'

const props = defineProps({
  form: { type: Object, required: true },
  prop: { type: String, required: true },
  idAll: { type: Boolean, default: false },
  emitter: { type: TinyEmitter, required: true },
  seledStop: { type: Boolean, default: true }
})
const emit = defineEmits(['selEleClear', 'selEleStart', 'eleIdenChange', 'eleSelected'])
const form = toRef(props.form)
const element = computed<PageEle>(() => getProp(form.value, props.prop))
const idType = computed<IdType>(() => getProp(element.value, 'idType'))
const idxLbl = computed<number>(() => getProp(element.value, 'index'))
const label = computed<string>(() =>
  getProp(element.value, idType.value)
  + (!element.value.idAll && idxLbl.value !== -1 && idType.value !== 'xpath' ? `[${idxLbl.value}]` : '')
)
const selecting = ref(false)
const selEle = ref<PageEle>()

props.emitter.on('ele-selected', (ele?: PageEle) => {
  selEle.value = ele
  if (selecting.value && ele) {
    onEleSelected(ele)
    if (props.seledStop) {
      props.emitter.emit('stop-select')
    }
    selecting.value = false
  }
})

function onSelEleStart() {
  if (selEle.value) {
    onEleSelected(selEle.value)
  } else if (selecting.value) {
    selecting.value = false
    props.emitter.emit('stop-select')
  } else {
    selecting.value = true
    props.emitter.emit('start-select')
    emit('selEleStart', props.prop)
  }
}
function onEleSelected(ele: PageEle) {
  const cpEle = PageEle.copy(selEle.value)
  cpEle.idAll = props.idAll
  setProp(form.value, props.prop, cpEle)
  emit('eleSelected', props.prop, form.value)
}
function onElIdChange({ key }: any) {
  setProp(form.value, props.prop + '.idType', key)
  emit('eleIdenChange', props.prop, key)
}
function onSelEleClear() {
  selecting.value = false
  setProp(form.value, props.prop, undefined)
  emit('selEleClear', props.prop)
}
</script>
